name: Accept Submission

on:
  workflow_dispatch:
    inputs:
      pack_root_sha256:
        description: 'SHA-256 attestation fingerprint'
        required: true
      source_repo:
        description: 'Source repo (owner/repo)'
        required: true
      pack_manifest_b64:
        description: 'Base64-encoded pack_manifest.json (enables L2 witness verification)'
        required: false
        default: ''
      pack_id:
        description: 'Pack ID (ignored if manifest provided)'
        required: false
        default: ''
      receipt_integrity:
        description: 'PASS or FAIL (ignored if manifest provided)'
        required: false
        default: ''
      claim_check:
        description: 'PASS, FAIL, or N/A (ignored if manifest provided)'
        required: false
        default: ''
      n_receipts:
        description: 'Number of receipts (ignored if manifest provided)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ledger-submit-${{ inputs.pack_root_sha256 }}
  cancel-in-progress: false

jobs:
  submit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PyNaCl
        run: pip install pynacl --quiet

      - name: Check for duplicate
        id: check
        env:
          INPUT_PACK_ROOT_SHA256: ${{ inputs.pack_root_sha256 }}
        run: |
          python3 - <<'PY'
          import json, os, sys
          target = os.environ["INPUT_PACK_ROOT_SHA256"].strip()
          if not target:
              print("::error::pack_root_sha256 is empty")
              sys.exit(1)
          try:
              with open("ledger.jsonl") as f:
                  for line in f:
                      line = line.strip()
                      if not line:
                          continue
                      if json.loads(line).get("pack_root_sha256") == target:
                          print("Entry already exists in ledger")
                          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
                              out.write("duplicate=true\n")
                          sys.exit(0)
          except FileNotFoundError:
              pass
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write("duplicate=false\n")
          PY

      - name: Witness verify and build entry
        id: build
        if: steps.check.outputs.duplicate == 'false'
        env:
          INPUT_PACK_ROOT_SHA256: ${{ inputs.pack_root_sha256 }}
          INPUT_SOURCE_REPO: ${{ inputs.source_repo }}
          INPUT_PACK_MANIFEST_B64: ${{ inputs.pack_manifest_b64 }}
          INPUT_PACK_ID: ${{ inputs.pack_id }}
          INPUT_RECEIPT_INTEGRITY: ${{ inputs.receipt_integrity }}
          INPUT_CLAIM_CHECK: ${{ inputs.claim_check }}
          INPUT_N_RECEIPTS: ${{ inputs.n_receipts }}
        run: |
          python3 - <<'PY'
          import json, os, re, sys
          from datetime import datetime, timezone

          SHA256_RE = re.compile(r"^[0-9a-f]{64}$")
          VALID_INTEGRITY = {"PASS", "FAIL"}
          VALID_CLAIM = {"PASS", "FAIL", "N/A"}
          REPO_RE = re.compile(r"^[\w.-]+/[\w.-]+$")

          root = os.environ["INPUT_PACK_ROOT_SHA256"].strip()
          source_repo = os.environ["INPUT_SOURCE_REPO"].strip()
          manifest_b64 = os.environ.get("INPUT_PACK_MANIFEST_B64", "").strip()

          if not root or not SHA256_RE.match(root):
              print("::error::pack_root_sha256 is not valid hex SHA-256", file=sys.stderr)
              sys.exit(1)
          if not source_repo or not REPO_RE.match(source_repo):
              print("::error::source_repo must match owner/repo format", file=sys.stderr)
              sys.exit(1)

          now = datetime.now(timezone.utc).isoformat()

          if manifest_b64:
              # === WITNESSED PATH: build entry from witness-extracted fields ===
              from witness_verify import witness_verify
              result = witness_verify(manifest_b64, root)

              if not result.ok:
                  print("::error::Witness verification failed:", file=sys.stderr)
                  for e in result.errors:
                      print(f"  - {e}", file=sys.stderr)
                  sys.exit(1)

              ext = result.extracted
              entry = {
                  "schema_version": 1,
                  "pack_root_sha256": ext["pack_root_sha256"],
                  "pack_id": ext.get("pack_id", ""),
                  "receipt_integrity": ext.get("receipt_integrity", "UNKNOWN"),
                  "claim_check": ext.get("claim_check", "N/A"),
                  "n_receipts": ext.get("n_receipts", 0),
                  "submitted_at": now,
                  "source_repo": source_repo,
                  "witness_status": result.witness_status,
              }
              # Add optional fields from witness extraction
              for key in ("mode", "assurance_level", "timestamp_start", "timestamp_end",
                          "signer_pubkey_sha256", "verifier_version"):
                  val = ext.get(key)
                  if val:
                      entry[key] = val

              print(f"Witness: {result.witness_status}")
          else:
              # === UNWITNESSED PATH: accept self-reported fields ===
              pack_id = os.environ.get("INPUT_PACK_ID", "").strip()
              integrity = os.environ.get("INPUT_RECEIPT_INTEGRITY", "").strip()
              claim = os.environ.get("INPUT_CLAIM_CHECK", "").strip()
              n_str = os.environ.get("INPUT_N_RECEIPTS", "").strip()

              if not pack_id or not integrity or not claim or not n_str:
                  print("::error::Without pack_manifest_b64, pack_id/receipt_integrity/claim_check/n_receipts are required",
                        file=sys.stderr)
                  sys.exit(1)
              if integrity not in VALID_INTEGRITY:
                  print(f"::error::receipt_integrity must be PASS or FAIL", file=sys.stderr)
                  sys.exit(1)
              if claim not in VALID_CLAIM:
                  print(f"::error::claim_check must be PASS/FAIL/N/A", file=sys.stderr)
                  sys.exit(1)
              try:
                  n_receipts = int(n_str)
              except ValueError:
                  print("::error::n_receipts must be an integer", file=sys.stderr)
                  sys.exit(1)

              entry = {
                  "schema_version": 1,
                  "pack_root_sha256": root,
                  "pack_id": pack_id,
                  "receipt_integrity": integrity,
                  "claim_check": claim,
                  "n_receipts": n_receipts,
                  "submitted_at": now,
                  "source_repo": source_repo,
                  "witness_status": "unwitnessed",
              }
              print("Warning: no manifest provided, entry is unwitnessed")

          with open("ledger.jsonl", "a") as f:
              f.write(json.dumps(entry, separators=(",", ":")) + "\n")

          print(f"Appended: {entry['pack_root_sha256'][:16]}... ({entry.get('pack_id', '?')})")
          print(f"  witness_status={entry.get('witness_status', 'unwitnessed')}")
          PY

      - name: Validate
        if: steps.check.outputs.duplicate == 'false'
        run: python3 validate_ledger.py

      - name: Create PR
        if: steps.check.outputs.duplicate == 'false'
        env:
          INPUT_PACK_ROOT_SHA256: ${{ inputs.pack_root_sha256 }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="submit/${INPUT_PACK_ROOT_SHA256:0:16}"
          git checkout -b "$BRANCH"
          git add ledger.jsonl
          git config user.name "assay-ledger[bot]"
          git config user.email "noreply@assay-ledger"
          git commit -m "ledger: append entry"
          git push origin "$BRANCH"

          python3 - <<'PY'
          import os, subprocess
          root = os.environ["INPUT_PACK_ROOT_SHA256"]
          title = f"Ledger: {root[:16]}..."
          body = "New ledger entry submitted via workflow_dispatch.\n\nRun `python3 validate_ledger.py` to verify."
          subprocess.run(
              ["gh", "pr", "create", "--title", title, "--body", body],
              check=True,
          )
          PY
